<form [formGroup]="formGroup" [bitSubmit]="submit">
  <bit-dialog dialogSize="large">
    <span bitDialogTitle>
      {{ "share" | i18n }}
    </span>
    <div bitDialogContent>
      <!-- Loading State -->
      <ng-container *ngIf="loading" #spinner>
        <i class="bwi bwi-spinner bwi-lg bwi-spin" aria-hidden="true"></i>
      </ng-container>

      <!-- Step 1: Initial Share Form -->
      <div *ngIf="!loading && !showExistingCollectionStep && !sharingComplete">
        <div class="tw-mb-4 tw-text-muted">
          Create a name for the Collection, or leave it blank for Bitwarden to automatically create
          a name
        </div>
        <bit-form-field>
          <bit-label>{{ "name" | i18n }}</bit-label>
          <input bitInput appAutofocus formControlName="collectionName" />
          <bit-hint>{{ "optional" | i18n }}</bit-hint>
        </bit-form-field>

        <div class="tw-mb-3">
          <span>{{ "grantCollectionAccess" | i18n }}</span>
        </div>

        <bit-access-selector
          *ngIf="organization?.useGroups"
          [permissionMode]="PermissionMode.Edit"
          formControlName="access"
          [items]="accessItems"
          [columnHeader]="'groupSlashMemberColumnHeader' | i18n"
          [selectorLabelText]="'selectGroupsAndMembers' | i18n"
          [selectorHelpText]="'userPermissionOverrideHelperDesc' | i18n"
          [emptySelectionText]="'noMembersOrGroupsAdded' | i18n"
        ></bit-access-selector>
        <bit-access-selector
          *ngIf="!organization?.useGroups"
          [permissionMode]="PermissionMode.Edit"
          formControlName="access"
          [items]="accessItems"
          [columnHeader]="'memberColumnHeader' | i18n"
          [selectorLabelText]="'selectMembers' | i18n"
          [emptySelectionText]="'noMembersAdded' | i18n"
        ></bit-access-selector>
      </div>

      <!-- Step 2: Existing Collection Assignment -->
      <div *ngIf="!loading && showExistingCollectionStep && !sharingComplete">
        <div class="tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-mb-2">Existing collection exists</h3>
          <p class="tw-text-muted">
            <strong>{{ existingCollection?.name }}</strong> already exists with the same
            permissions.
          </p>
        </div>
      </div>

      <!-- Step 3: Success State with Shareable Link -->
      <div *ngIf="!loading && sharingComplete">
        <div class="tw-mb-4">
          <h3 class="tw-text-lg tw-font-semibold tw-mb-2">Item shared successfully!</h3>
        </div>

        <!-- Shareable Link Section -->
        <div class="tw-mt-6 tw-border-t tw-border-secondary-300 tw-pt-4">
          <div class="tw-mb-3">
            <span class="tw-font-semibold">Copy Share Link</span>
          </div>
          <div class="tw-flex tw-gap-2">
            <input bitInput readonly [value]="shareableLink" class="tw-flex-1" #shareLinkInput />
            <button
              type="button"
              bitButton
              buttonType="secondary"
              (click)="copyShareLink(shareLinkInput)"
              title="Copy link"
            >
              <i class="bwi bwi-clone" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    <ng-container bitDialogFooter>
      <!-- Step 1: Initial Share Form Buttons -->
      <button
        *ngIf="!showExistingCollectionStep && !sharingComplete"
        type="submit"
        bitButton
        bitFormButton
        buttonType="primary"
        [disabled]="loading || !canSave || submitting"
      >
        {{ "save" | i18n }}
      </button>

      <!-- Step 2: Existing Collection Assignment Buttons -->
      <button
        *ngIf="showExistingCollectionStep && !sharingComplete"
        type="button"
        bitButton
        bitFormButton
        buttonType="primary"
        (click)="assignToExistingCollection()"
        [disabled]="submitting"
      >
        {{ "save" | i18n }}
      </button>

      <!-- Step 3: Success State Button -->
      <button
        *ngIf="sharingComplete"
        type="button"
        bitButton
        bitFormButton
        buttonType="primary"
        (click)="done()"
      >
        Done
      </button>

      <!-- Cancel Button (shown in steps 1 and 2) -->
      <button
        *ngIf="!sharingComplete"
        type="button"
        bitButton
        bitFormButton
        buttonType="secondary"
        (click)="cancel()"
        [disabled]="loading || submitting"
      >
        {{ "cancel" | i18n }}
      </button>
    </ng-container>
  </bit-dialog>
</form>

<form [formGroup]="formGroup" [bitSubmit]="submit">
  <bit-dialog dialogSize="large">
    <span bitDialogTitle>
      @if (!isBulkShare && !sharingComplete) {
        {{ "share" | i18n }} "{{ decryptedCipherName }}"
      }
      @if (isBulkShare && !sharingComplete) {
        {{ "share" | i18n }} {{ ciphers.length }} {{ "items" | i18n }}
      }
    </span>
    <div bitDialogContent>
      <!-- Loading State -->
      @if (loading) {
        <i class="bwi bwi-spinner bwi-lg bwi-spin" aria-hidden="true"></i>
      }

      <!-- Step 1: Initial Share Form -->
      @if (!loading && !showExistingCollectionStep && !sharingComplete) {
        <div>
          <!-- Description for single item sharing -->
          @if (!isBulkShare) {
            <div class="tw-mb-4 tw-text-main">
              Grant groups or members access to "{{ decryptedCipherName }}"
            </div>
          }

          @if (isBulkShare) {
            <div class="tw-mb-4 tw-text-main">
              Create a name for this Share and grant groups or members access to the
              {{ ciphers.length }} items.
            </div>
          }
          <bit-form-field>
            <bit-label>Collection name (required)</bit-label>
            <input
              id="share-modal_input_collection-name"
              bitInput
              [appAutofocus]="isBulkShare"
              formControlName="collectionName"
              [required]="isBulkShare"
            />
          </bit-form-field>

          @if (organization?.useGroups) {
            <bit-access-selector
              [permissionMode]="PermissionMode.Edit"
              formControlName="access"
              [items]="accessItems"
              [columnHeader]="'groupSlashMemberColumnHeader' | i18n"
              [selectorLabelText]="'selectGroupsAndMembers' | i18n"
              [selectorHelpText]="'userPermissionOverrideHelperDesc' | i18n"
              [emptySelectionText]="'noMembersOrGroupsAdded' | i18n"
            ></bit-access-selector>
          }
          @if (!organization?.useGroups) {
            <bit-access-selector
              [permissionMode]="PermissionMode.Edit"
              formControlName="access"
              [items]="accessItems"
              [columnHeader]="'memberColumnHeader' | i18n"
              [selectorLabelText]="'selectMembers' | i18n"
              [emptySelectionText]="'noMembersAdded' | i18n"
            ></bit-access-selector>
          }
        </div>
      }

      <!-- Step 2: Existing Collection Assignment -->
      @if (!loading && showExistingCollectionStep && !sharingComplete) {
        <div>
          <div class="tw-mb-4">
            <h3 class="tw-text-lg tw-font-semibold tw-mb-2">Existing collection found</h3>
            <p class="tw-text-muted tw-mb-4">
              <strong>{{ existingCollection?.name }}</strong> already exists with the same
              permissions.
            </p>

            <!-- Permission Preview -->
            <div class="tw-border tw-border-secondary-300 tw-rounded tw-p-4 tw-bg-background-alt">
              <h4 class="tw-font-semibold tw-mb-3 tw-flex tw-items-center tw-gap-2">
                <i class="bwi bwi-collection" aria-hidden="true"></i>
                <span>{{ existingCollection?.name }}</span>
              </h4>

              <!-- User Permissions -->
              @if (existingCollection?.users && existingCollection.users.length > 0) {
                <div class="tw-mb-3">
                  <div class="tw-text-sm tw-font-semibold tw-text-muted tw-mb-2">Members:</div>
                  @for (user of existingCollection.users; track user.id) {
                    <div class="tw-text-sm tw-ml-2 tw-mb-1">
                      <span class="tw-font-medium">{{ getUserDisplayName(user.id) }}</span>
                      <span class="tw-text-muted"> - {{ getPermissionLabel(user) }}</span>
                    </div>
                  }
                </div>
              }

              <!-- Group Permissions -->
              @if (existingCollection?.groups && existingCollection.groups.length > 0) {
                <div>
                  <div class="tw-text-sm tw-font-semibold tw-text-muted tw-mb-2">Groups:</div>
                  @for (group of existingCollection.groups; track group.id) {
                    <div class="tw-text-sm tw-ml-2 tw-mb-1">
                      <span class="tw-font-medium">{{ getGroupDisplayName(group.id) }}</span>
                      <span class="tw-text-muted"> - {{ getPermissionLabel(group) }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      }

      <!-- Step 3: Success State with Shareable Link -->
      @if (!loading && sharingComplete) {
        <div>
          <div class="tw-mb-4">
            <h3 class="tw-text-lg tw-font-semibold tw-mb-2">
              Shared {{ createdCollectionName }} successfully!
            </h3>
          </div>

          <!-- Shareable Link Section -->
          <div class="tw-mt-6 tw-border-t tw-border-secondary-300 tw-pt-4">
            <div class="tw-mb-3">
              <span class="tw-font-semibold">Copy Share Link</span>
            </div>
            <div class="tw-flex tw-gap-2">
              <input
                id="share-modal_input_shareable-link"
                bitInput
                readonly
                [value]="shareableLink"
                class="tw-flex-1"
                #shareLinkInput
              />
              <button
                id="share-modal_button_copy-link"
                type="button"
                bitButton
                buttonType="secondary"
                (click)="copyShareLink(shareLinkInput)"
                title="Copy link"
              >
                <i class="bwi bwi-clone" aria-hidden="true"></i>
              </button>
            </div>
          </div>
        </div>
      }
    </div>
    <ng-container bitDialogFooter>
      <!-- Step 1: Initial Share Form Buttons -->
      @if (!showExistingCollectionStep && !sharingComplete) {
        <button
          id="share-modal_button_save"
          type="submit"
          bitButton
          bitFormButton
          buttonType="primary"
          [disabled]="loading || !canSave || submitting"
        >
          {{ "save" | i18n }}
        </button>
      }

      <!-- Step 2: Existing Collection Assignment Buttons -->
      @if (showExistingCollectionStep && !sharingComplete) {
        <button
          id="share-modal_button_use-existing"
          type="button"
          bitButton
          bitFormButton
          buttonType="primary"
          (click)="assignToExistingCollection()"
          [disabled]="submitting"
        >
          Use existing
        </button>
      }
      @if (showExistingCollectionStep && !sharingComplete) {
        <button
          id="share-modal_button_create-new"
          type="button"
          bitButton
          bitFormButton
          buttonType="secondary"
          (click)="createNewCollectionAnyway()"
          [disabled]="submitting"
        >
          Create new
        </button>
      }

      <!-- Step 3: Success State Button -->
      @if (sharingComplete) {
        <button
          id="share-modal_button_done"
          type="button"
          bitButton
          bitFormButton
          buttonType="primary"
          (click)="done()"
        >
          Done
        </button>
      }

      <!-- Cancel Button (shown in steps 1 and 2) -->
      @if (!sharingComplete) {
        <button
          id="share-modal_button_cancel"
          type="button"
          bitButton
          bitFormButton
          buttonType="secondary"
          (click)="cancel()"
          [disabled]="loading || submitting"
        >
          {{ "cancel" | i18n }}
        </button>
      }
    </ng-container>
  </bit-dialog>
</form>
